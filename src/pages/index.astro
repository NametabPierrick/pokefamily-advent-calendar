---
import BaseLayout from "../layouts/BaseLayout.astro";
import { MEMBERS, TOTAL_DAYS } from "../data/members";
---

<BaseLayout
  title="Calendrier de l'avent"
  description="Chaque membre de la famille a son calendrier de surprises qui se d√©bloquent jour apr√®s jour."
>
  <header>
    <div class="brand">
      <div class="crest">üéÅ</div>
      <div>
        <h1>Calendrier de l'avent <br />de la Pok√©family</h1>
      </div>
    </div>
    <div class="badge">1 ‚Üí {TOTAL_DAYS} d√©cembre</div>
  </header>

  <p class="intro">
    Chaque membre de la famille a son calendrier personnel. Clique sur ton nom
    pour voir les surprises qui se d√©bloquent jour apr√®s jour.
  </p>

  <div class="hero" data-total-days={TOTAL_DAYS}>
    <h2 class="countdown" data-countdown>No√´l approche √† grand pas !</h2>
    <p class="sub-countdown" data-next-countdown>
      Chargement du prochain paquet‚Ä¶
    </p>
  </div>

  <div class="card-grid">
    {
      MEMBERS.map((member) => (
        <a class="card" href={`/${member.id}`} data-member={member.id}>
          <h2>{member.name}</h2>
          <span class="member-name-outline">{member.name}</span>
          <p class="muted">Tous les jours une surprise !</p>
          <span class="btn card-btn">
            Voir le calendrier de l'avent
            <span aria-hidden="true">‚ÜóÔ∏é</span>
          </span>
        </a>
      ))
    }
  </div>

  <script>
    const search = new URLSearchParams(window.location.search);
    const debug = search.get("debugDate");

    function parseDebugDate(value) {
      if (!value) return null;
      const parts = value.split("-").map((n) => Number(n));
      if (parts.length !== 3 || parts.some(Number.isNaN)) return null;
      const [year, month, day] = parts;
      const nowTime = new Date();
      return new Date(
        year,
        month - 1,
        day,
        nowTime.getHours(),
        nowTime.getMinutes(),
        nowTime.getSeconds(),
        nowTime.getMilliseconds(),
      );
    }

    const debugDate = parseDebugDate(debug);
    const baseDate = debugDate ?? new Date();
    const seasonYear = baseDate.getFullYear();
    const baseMs = baseDate.getTime();
    const startReal = Date.now();
    const useDebug = !!debugDate;
    const pad2 = (n) => String(n).padStart(2, "0");
    const getNowMs = () =>
      useDebug ? baseMs + (Date.now() - startReal) : Date.now();
    const totalDays = Number(
      document.querySelector("[data-total-days]")?.dataset.totalDays || 24,
    );

    const countdownNode = document.querySelector("[data-countdown]");
    if (countdownNode) {
      const target = new Date(seasonYear, 11, 25, 0, 0, 0, 0).getTime();
      const fmt = (value, unit) =>
        `<span class="count-value">${value}</span><span class="count-unit">${unit}</span>`;

      const updateCountdown = () => {
        const nowMs = getNowMs();
        const diff = target - nowMs;
        if (diff <= 0) {
          countdownNode.innerHTML = `<span class="count-number">Joyeux No√´l !</span>`;
          return;
        }
        const totalSeconds = Math.floor(diff / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        countdownNode.innerHTML = `
          <span class="count-number">
            ${fmt(days, "j")} ${fmt(pad2(hours), "h")} ${fmt(pad2(minutes), "m")} ${fmt(pad2(seconds), "s")}
          </span>
          <span class="count-label">avant No√´l</span>
        `;
      };

      updateCountdown();
      setInterval(updateCountdown, 1000);
    }

    const nextCountdownNode = document.querySelector("[data-next-countdown]");
    if (nextCountdownNode) {
      const now = new Date(getNowMs());
      const start = new Date(seasonYear, 11, 1);
      const end = new Date(seasonYear, 11, totalDays, 23, 59, 59, 999);

      let openDay = 0;
      if (now < start) {
        openDay = 0;
      } else if (now > end) {
        openDay = totalDays;
      } else if (now.getMonth() === 11) {
        openDay = Math.min(totalDays, now.getDate());
      }

      const nextDay = openDay < totalDays ? openDay + 1 : null;
      const nextTarget =
        nextDay !== null
          ? new Date(seasonYear, 11, nextDay, 0, 0, 0, 0).getTime()
          : null;

      const formatLabel = (days, hours, minutes, seconds) => {
        const parts = [];
        if (days > 0) parts.push(`${days}j`);
        parts.push(`${pad2(hours)}h${pad2(minutes)}m${pad2(seconds)}s`);
        return parts.join(" ");
      };

      const updateNextCountdown = () => {
        if (nextTarget === null || nextDay === null) {
          nextCountdownNode.textContent = "Tous les paquets sont ouverts !";
          return;
        }
        const diff = nextTarget - getNowMs();
        if (diff <= 0) {
          nextCountdownNode.textContent = `Paquet num√©ro ${nextDay} pr√™t !`;
          return;
        }
        const totalSeconds = Math.floor(diff / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        nextCountdownNode.textContent = `${formatLabel(
          days,
          hours,
          minutes,
          seconds,
        )} avant le paquet num√©ro ${nextDay}`;
      };

      updateNextCountdown();
      setInterval(updateNextCountdown, 1000);
    }
  </script>
</BaseLayout>
